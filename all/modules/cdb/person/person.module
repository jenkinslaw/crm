<?php
/**
 * @file
 * Code for the person feature.
 */

#include_once 'person.features.inc';
#include_once 'includes/Person.inc';


function person_form_alter(&$form, &$form_state, $form_id) {
    if ($form_id == 'eck__entity__form_add_person_person') {
      $form['#validate'][] = "person_form_validate";
    }
}
 
function person_form_validate($form, &$form_state) {
  _person_form_validate($form_state);
}

function _person_form_validate(&$form_state) {
  person_phone_number_validate($form_state);
}

function person_phone_number_validate(&$form_state) {
  $phone_numbers = $form_state['values']['fgm_person_person_form_group_phone']['fields']['items'];
  foreach ($phone_numbers as $index => $phone_number) {
    $number = $phone_number['phone_number']['und']['value'];
    $type   = $phone_number['phone_type']['und'][0]['value'];
    $matches = phone_number_regex_match($number);
    if (!$matches) {
      $field = "fgm_person_person_form_group_phone][fields][items][{$index}][phone_number][und][value";
      form_set_error($field, t("The {$type} number {$number} is not valid"));
    }
    else {
      person_phone_number_only_numeric($form_state, $matches, $index);
    }
  }
}

/**
 * Checks for valid US phone number, ie  10 digits in 3 groups
 * Takes phone number with or without parenthesis around area code
 * Takes no space, space, dash or period between number groups
 * Returns array with 4 elements : 
 * Number as entered, 
 * Three digits of group 1
 * Three digits of group 2 
 * Three digits of group 3
 * 
 */
function phone_number_regex_match($number){
  $pattern = '/^\(?(\d{3})\)?[[:space:]-.]?(\d{3})[[:space:]-.]?(\d{4})$/';
  preg_match($pattern, $number, $matches);
  return $matches;
}
/**
 * Transforms 4 element regex matches array from phone_number_regex_match
 * into a 10 digit string.  
 */
function phone_number_only_numeric($number_array){
  return join(array_slice($number_array, 1));
}

/**
 * Alters the submitted phone number to a 10 digit string for storage in 
 * the db, no matter what formatted it was submitted in.
 * Specific to the Person Entity form.
 */
function person_phone_number_only_numeric(&$form_state, $number_array, $index) {
  $number = phone_number_only_numeric($number_array);
  $form_state['values']['fgm_person_person_form_group_phone']['fields']['items'][$index]['phone_number']['und']['value'] = $number;
}
